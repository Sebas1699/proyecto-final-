<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Panel - Portal de Empleo</title>
    <link rel="stylesheet" href="/roll/usuario/dashboard-styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <header class="dashboard-header">
        <h1>Perfil Personal</h1>
        <button id="logout-btn">Cerrar Sesión</button>
    </header>

    <main class="dashboard-container">
        <!-- crear o editar la hoja de vida -->
        <section class="card">
            <div id="cv-display">
                <!-- mostrará la hoja de vida  -->
                <div class="cv-header">
                    <h2>Mi Hoja de Vida</h2>
                    <button id="edit-cv-btn" class="btn-secondary">Editar</button>
                </div>
                <div id="cv-content-display"></div>
            </div>

            <div id="cv-edit" style="display: none;">
                <!-- formulario de la hija de vida -->
                <h2>Hoja de Vida</h2>
                <p>Completa y actualiza tu información profesional.</p>
                <div id="cv-message-container" class="message"></div>
                <form id="cv-form">
                    <div class="form-group">
                        <label for="perfil_profesional">Perfil Profesional</label>
                        <textarea id="perfil_profesional" name="perfil_profesional" rows="4" placeholder="Un breve resumen sobre ti..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="experiencia">Experiencia Laboral</label>
                        <textarea id="experiencia" name="experiencia" rows="4" placeholder="Tus trabajos anteriores..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="educacion">Educación</label>
                        <textarea id="educacion" name="educacion" rows="4" placeholder="Tus estudios y títulos..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="habilidades">Habilidades</label>
                        <textarea id="habilidades" name="habilidades" rows="3" placeholder="Ej: JavaScript, Liderazgo, Excel..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="idiomas">Idiomas</label>
                        <textarea id="idiomas" name="idiomas" rows="2" placeholder="Ej: Inglés (Avanzado), Francés (Básico)..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="referencias">Referencias</label>
                        <textarea id="referencias" name="referencias" rows="3" placeholder="Referencias personales o profesionales..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="cargo_aplicar">Cargo al que Aplicas</label>
                        <input type="text" id="cargo_aplicar" name="cargo_aplicar" placeholder="Ej: Desarrollador Full-Stack" required>
                    </div>
                    <div class="form-group">
                        <label for="foto_perfil_archivo">Foto de Perfil (subir archivo)</label>
                        <input type="file" id="foto_perfil_archivo" name="foto_perfil_archivo" accept="image/*">
                        <!-- Campo oculto para mantener la foto existente si no se sube una nueva -->
                        <input type="hidden" id="foto_perfil_existente" name="foto_perfil_existente">
                    </div>
                    <button type="submit" class="btn-submit">Guardar Cambios</button>
                    <button type="button" id="cancel-edit-btn" class="btn-secondary">Cancelar</button>
                </form>
            </div>

            <div id="cv-create-prompt" style="display: none;">
                <!-- mensaje de no hay hoja de vida -->
                <h2>Hoja de Vida</h2>
                <p>Aún no has creado tu hoja de vida. ¡Es el primer paso hacia tu próximo empleo!</p>
                <button id="create-cv-btn" class="btn-submit">Crear Hoja de Vida</button>
            </div>
        </section>

        <!-- Sección para ver vacantes disponibles -->
        <section class="card">
            <h2>Vacantes Disponibles</h2>
            <p>Explora las oportunidades y postúlate a la que más te interese.</p>
            <div id="vacancies-container">
                <!-- Las vacantes se cargarán aquí dinámicamente -->
            </div>
        </section>

        <!-- Sección para visualizar MIS postulaciones -->
        <section class="card">
            <h2>Mis Postulaciones</h2>
            <p>Aquí verás el estado de las postulaciones que has realizado.</p>
            <div id="my-applications-container">
            </div>
        </section>
    </main>

    <script>
        // Referencias a los elementos del DOM
        const cvDisplay = document.getElementById('cv-display');
        const cvEdit = document.getElementById('cv-edit');
        const cvCreatePrompt = document.getElementById('cv-create-prompt');
        const vacanciesContainer = document.getElementById('vacancies-container');
        const myApplicationsContainer = document.getElementById('my-applications-container');

        // cerrar sesión
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('token'); // Eliminamos el token
            window.location.href = '/login.html'; // Redirigimos al login
        });

        // --- cargar los datos de la hoja de vida al entrar a la página ---
        document.addEventListener('DOMContentLoaded', async () => {
            let cvData = {}; // almacenar los datos de la hoja de vida

            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            try {
                const response = await fetch('/api/cv', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login.html';
                    return;
                }

                if (response.ok) {
                    cvData = await response.json();
                    // Decidimos qué mostrar basado en si existe un id_hoja (lo que confirma que hay una hoja de vida)
                    if (cvData && cvData.id_hoja) {
                        showDisplayMode(cvData);
                        // Si tiene CV, primero cargamos sus postulaciones para saber a qué ha aplicado
                        const appliedVacancies = await loadMyApplications(token);
                        // Luego cargamos las vacantes, pasando la lista de las ya aplicadas
                        loadVacancies(token, appliedVacancies);
                    } else {
                        showCreateMode();
                        vacanciesContainer.innerHTML = '<p>Crea tu hoja de vida para poder ver y postularte a las vacantes.</p>';
                        myApplicationsContainer.innerHTML = '<p>Aún no tienes postulaciones.</p>';
                    }
                }
            } catch (error) {
                console.error('Error al cargar la hoja de vida:', error);
                cvCreatePrompt.innerHTML = '<p class="error">Error al cargar tus datos. Intenta recargar la página.</p>';
            }

            // Lógica de los botones
            document.getElementById('create-cv-btn').addEventListener('click', () => {
                showEditMode({}); // Muestra el formulario vacío
            });

            document.getElementById('edit-cv-btn').addEventListener('click', () => {
                showEditMode(cvData); // Muestra el formulario con los datos cargados
            });

            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                // Si hay datos, vuelve a la vista de display, si no, a la de crear
                if (cvData && cvData.id_hoja) {
                    showDisplayMode(cvData);
                } else {
                    showCreateMode();
                }
            });
        });

        // Funciones para controlar la visibilidad
        function showDisplayMode(data) {
            // Rellenar la vista de solo lectura
            const displayContent = document.getElementById('cv-content-display');
            
            // Generar el HTML para la imagen solo si la URL existe
            const imageHtml = data.foto_perfil 
                ? `<img src="${data.foto_perfil}" alt="Foto de Perfil" class="profile-picture">`
                : '';

            // Función auxiliar para evitar repetir 'No especificado'
            const displayField = (label, value) => `<p><strong>${label}:</strong> ${value || 'No especificado'}</p>`;

            displayContent.innerHTML = `
                ${imageHtml}
                <h3>Datos Personales</h3>
                ${displayField('Nombres', data.nombres)}
                ${displayField('Apellidos', data.apellidos)}
                
                <h3>Información Profesional</h3>
                ${displayField('Cargo al que Aplicas', data.cargo_aplicar)}
                ${displayField('Perfil Profesional', data.perfil_profesional)}
                ${displayField('Experiencia Laboral', data.experiencia)}
                ${displayField('Educación', data.educacion)}
                ${displayField('Habilidades', data.habilidades)}
                ${displayField('Idiomas', data.idiomas)}
                ${displayField('Referencias', data.referencias)}
            `;
            cvDisplay.style.display = 'block';
            cvEdit.style.display = 'none';
            cvCreatePrompt.style.display = 'none';
        }

        function showEditMode(data) {
            // Lista de campos del formulario que esperamos rellenar
            const formFields = [
                'perfil_profesional', 'experiencia', 'educacion', 
                'habilidades', 'idiomas', 'referencias', 'cargo_aplicar'
            ];

            // Rellenamos cada campo si existe en los datos
            formFields.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.value = data[fieldId] || ''; // Usamos '' si el dato es null o undefined
                }
            });

            // Manejo especial para la foto de perfil existente
            document.getElementById('foto_perfil_existente').value = data.foto_perfil || '';
            document.getElementById('foto_perfil_archivo').value = ''; // Limpiamos el input de archivo

            cvDisplay.style.display = 'none';
            cvEdit.style.display = 'block';
            cvCreatePrompt.style.display = 'none';
        }

        function showCreateMode() {
            cvDisplay.style.display = 'none';
            cvEdit.style.display = 'none';
            cvCreatePrompt.style.display = 'block';
        }

        // --- NUEVAS FUNCIONES PARA VACANTES Y POSTULACIONES ---

        async function loadVacancies(token, appliedVacancies = []) {
            try {
                const response = await fetch('/api/vacancies', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const vacancies = await response.json();

                if (vacancies.length === 0) {
                    vacanciesContainer.innerHTML = '<p>No hay vacantes disponibles en este momento.</p>';
                    return;
                }

                const appliedIds = new Set(appliedVacancies.map(app => app.id_vacante));

                let vacanciesHtml = '<ul>';
                vacancies.forEach(vacante => {
                    const isApplied = appliedIds.has(vacante.id_vacante);
                    const buttonHtml = isApplied
                        ? `<button class="btn-apply applied" disabled>Aplicaste</button>`
                        : `<button class="btn-apply" data-id="${vacante.id_vacante}">Aplicar</button>`;

                    vacanciesHtml += `
                        <li class="vacante-item">
                            <div>
                                <h4>${vacante.titulo}</h4>
                                <p>${vacante.descripcion}</p>
                            </div>
                            ${buttonHtml}
                        </li>
                    `;
                });
                vacanciesHtml += '</ul>';
                vacanciesContainer.innerHTML = vacanciesHtml;

            } catch (error) {
                vacanciesContainer.innerHTML = '<p class="error">No se pudieron cargar las vacantes.</p>';
            }
        }

        async function loadMyApplications(token) {
            try {
                const response = await fetch('/api/my-applications', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const applications = await response.json();

                if (applications.length === 0) {
                    myApplicationsContainer.innerHTML = '<p>Aún no te has postulado a ninguna vacante.</p>';
                    return []; // Devolvemos un array vacío
                }

                let applicationsHtml = '<ul>';
                applications.forEach(app => {
                    const statusClass = `status-${app.estado.replace(' ', '-')}`;
                    const statusText = app.estado.charAt(0).toUpperCase() + app.estado.slice(1);
                    let reviewedBy = '';
                    if (app.admin_nombre) {
                        reviewedBy = `<small>Revisado por: ${app.admin_nombre} ${app.admin_apellidos}</small>`;
                    }

                    applicationsHtml += `
                        <li class="application-item">
                            <div>
                                <h4>${app.vacante_titulo}</h4>
                                <p>${reviewedBy}</p>
                            </div>
                            <span class="status ${statusClass}">${statusText}</span>
                        </li>
                    `;
                });
                applicationsHtml += '</ul>';
                myApplicationsContainer.innerHTML = applicationsHtml;

                return applications; // Devolvemos las postulaciones para usarlas en loadVacancies

            } catch (error) { console.error(error); return []; }
        }

        // Delegación de eventos para los botones "Aplicar"
        vacanciesContainer.addEventListener('click', async (event) => {
            if (event.target.classList.contains('btn-apply')) {
                const vacanteId = event.target.dataset.id;
                const token = localStorage.getItem('token');
                const button = event.target;

                button.disabled = true;
                button.textContent = 'Aplicando...';

                try {
                    const response = await fetch(`/api/vacancies/${vacanteId}/apply`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const result = await response.json();

                    if (response.ok) {
                        button.textContent = '¡Aplicaste!';
                        button.classList.add('applied');
                        showToast(result.message);
                        loadMyApplications(token); // Recargamos la lista de postulaciones
                    } else {
                        showToast(result.message, 'error');
                        button.disabled = false;
                        button.textContent = 'Aplicar';
                    }
                } catch (error) { console.error(error); }
            }
        });

        // Lógica para guardar la hoja de vida
        const cvForm = document.getElementById('cv-form');
        const cvMessageContainer = document.getElementById('cv-message-container');

        cvForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            cvMessageContainer.textContent = '';
            cvMessageContainer.className = 'message';

            const token = localStorage.getItem('token');
            if (!token) {
                // Si por alguna razón no hay token, redirigimos al login
                window.location.href = '/login.html';
                return;
            }

            // Usamos FormData para poder enviar el archivo
            const formData = new FormData(cvForm); 

            try {
                const response = await fetch('/api/cv', {
                    method: 'POST',
                    headers: {
                        // NO establecemos 'Content-Type'. El navegador lo hará automáticamente
                        // por nosotros con el boundary correcto para FormData.
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData // Enviamos el objeto FormData directamente
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(result.message, 'success');
                    setTimeout(() => {
                        window.location.reload(); // Recargamos la página para ver los cambios
                    }, 1500);
                } else {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/login.html';
                        return;
                    }
                    showToast(result.message || 'Ocurrió un error.', 'error');
                }
            } catch (error) {
                showToast('Error de conexión con el servidor.', 'error');
            }
        });
    </script>
</body>
</html>